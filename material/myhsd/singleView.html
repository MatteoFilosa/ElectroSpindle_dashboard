<!doctype html>
<html>
<head>
    <!---Bootstrap-->

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>

    <title>Single spindle visualization</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="css/style_single.css"></link>
    <link rel="stylesheet" href="css/calendar.css">
    <script>
      
      function resetFilters() {
          
          localStorage.setItem("resetClicked", JSON.stringify(1))
          document.getElementById("day-start").innerHTML = ""
          document.getElementById("day-end").innerHTML = ""
          
          //document.getElementById("daButton").disabled = false
          sn_and_date = JSON.parse(localStorage.getItem("sn_and_date"))

       
          console.log(sn_and_date)

        }

      function showPopup(message, isSuccess) {
          var popup = document.getElementById("popup");
          popup.textContent = message;
          popup.className = "popup" + (isSuccess ? " success" : " error");
          popup.style.display = "block";

          // Nascondi il popup dopo 3 secondi
          setTimeout(function () {
            popup.style.display = "none";
          }, 3000);
        }


      function rimuoviDuplicati(array) {
          return Array.from(new Set(array));
        }
 

    const colors = [
        "#0074D9", // blu
        "#FF4136", // rosso
        "#2ECC40", // verde
        "#FF851B", // arancione
        "#7FDBFF", // celeste
        "#B10DC9", // viola
        "#FFDC00", // giallo
        "#001f3f", // blu scuro
        "#39CCCC", // verde acqua
        "#F012BE", // magenta
        "#3D9970", // verde scuro
        "#111111", // nero
        "#AAAAAA", // grigio
        "#DDDDDD", // grigio chiaro
      ];


    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
</head>

<body class="mx-4">
  <img src="images/home.png" style="vertical-align:middle" alt="check" width="25" height="25" onclick = "window.open('index_breakins.html', '_self');"> <a href = 'index_myhsd.html'>Back to spindle selection</a>
<p>Single spindle visualization</p>


<div id ="selectedSpindles"></div>
<br>
<input type="checkbox" id="aggregato" class="checkbox" onclick="aggregateHelper()"> Aggregate
<div id="selectedValues"></div>

<br><br>

<b>Columns</b>


<select id="selectMenuColumns">
  <option value="" disabled selected>Select attribute</option>
</select>

<button id="clear" onclick="clearSvg()" class="button-red">Clear all</button>

  <b id ="pickDate">Pick Date</b>
<div class="button-wrapper">

  <button class="button-green" onclick="displayCalendar(0)" id="fromButton">From</button>

  

  <button class="button-green" onclick="displayCalendar(1)" id="toButton">To</button>


  <button class="button-red" id="resetFilters" onclick="resetFilters()">Reset </button>
  

</div>
<div id="day-start"> </div>
<div id="day-end"> </div>

<div class="calendar" id="calendar-original" hidden="true">
  <div class="calendar-header">
    <span class="month-picker" id="month-picker">February</span>
    <div class="year-picker">
      <span class="year-change" id="prev-year">
        <pre><</pre>
      </span>
      <span id="year">2021</span>
      <span class="year-change" id="next-year">
        <pre>></pre>
      </span>
    </div>
  </div>
  <div class="calendar-body" id="calendar-body">
    <div class="calendar-week-day">
      <div>Sun</div>
      <div>Mon</div>
      <div>Tue</div>
      <div>Wed</div>
      <div>Thu</div>
      <div>Fri</div>
      <div>Sat</div>
    </div>
    <div class="calendar-days"></div>
  </div>
  <div class="calendar-footer">
    <div class="toggle">

    </div>
  </div>
  <div class="month-list" id="month-list"></div>
</div>


<div id="dstCalendar">

</div>


<script src="script/calendar.js"></script>



<!-- <div id = "selectedValues"></div>
<div id="tooltip"></div>
<br> -->

<!-- <div id = "downsamplePlaceholder">Insert downsample (current: 100)</div> <input type="text" id="downsample" maxlength="3" required placeholder="Downsample"> <button class="button-green" id="downsampleBtn" onclick = "restoreLoader()" >Apply</button> -->

<div id="popup" class="popup"></div>
<br><br>






    <!--
    <img src="images/warning.png" style="vertical-align:middle" alt="warning" width="25" height="25"> Problema in: Tba
     -->


    <!--<img src="images/2.png" style="vertical-align:middle" alt="check" width="150" height="80">-->

    
</div>
<div id = "analyticsDiv"></div>






<br>


<br><br><br><br>
<!-- <div class="container" id = "svg-div">
  <div class="row" id = "svg-row">
    
    <div class="col-sm">
      One of three columns
    </div>
    -->

  </div>
</div> 

<script>

  
  /* d3.json("http://arca.diag.uniroma1.it:8082/data/breakin/analytics", { crossOrigin: "anonymous" }).then(function (data) {

      for (let i = 0; i < data.length; i++){
        
        document.getElementById("analyticsDiv").innerHTML += "<button class = 'button-blue' onclick = 'analytics(this)'>" + data[i] +"</button>"
      }



    }) */

    function displayCalendar(flag) { // From : 0, To: 1

        localStorage.setItem("buttonClicked", JSON.stringify(flag))
        console.log("displaycalendar")
        calendar.hidden = false;
        //Migliorare popup
        if (flag == 0) calendar.style = "margin-left: 10px;"
        else calendar.style = "margin-left: 80px;"
        

      }

     
    var allGroup = [], allGroupColumns = [], sn_myhsd = JSON.parse(localStorage.getItem("sn_myhsd")), globalData; 
    

       d3.json("http://arca.diag.uniroma1.it:8082/data/myhsd/" + sn_myhsd + "/columns", { crossOrigin: "anonymous" })
          .then(function (data) {
            for (let i = 0; i < data.length; i++) {
              if(data[i] != "Failed hooks number tank") allGroupColumns.push(data[i].toString())
            }

            // Ordina i valori in ordine alfabetico
            allGroupColumns.sort();

            
            d3.select("#selectMenuColumns")
              .selectAll('myOptions')
              .data(allGroupColumns)
              .enter()
              .append('option')
              .text(function (d) { return d; })
              .attr("value", function (d) { return d; });

            
          });
      

  function analytics(button) {

   


    


      var selectedFeature = button.innerHTML;

      localStorage.setItem("selectedFeature", JSON.stringify(selectedFeature))
      
      var to_add = document.getElementById("selectedValues").childNodes
      var selectedAttributes = []

      for (let i = 0; i <= to_add.length; i++) {

        if (to_add[i] != undefined) {

          if ((to_add[i].id != null) && (to_add[i].checked == true)) {


            selectedAttributes.push(to_add[i].id)
          }
        }
      }

    localStorage.setItem("selectedAttributes", JSON.stringify(selectedAttributes))


    if (selectedAttributes.length > 0) {
      if (selectedFeature == "basic statistics") window.open('basic_statistics.html', '_blank');
      if ((selectedFeature == "pearson") && (selectedAttributes.length == 1)) showPopup("Select at least two attributes to show the pearson correlation.", false)

      else window.open('pearson.html', '_blank');

    }
    else showPopup("Select at least one attribute to continue.", false)
  }
 


  function sleep(time) {
      return new Promise((resolve) => setTimeout(resolve, time));
    }

  function displayTooltip(d) {
      document.getElementById("tooltip").style.visibility = "visible"
     
      var tooltip = document.getElementById("tooltip")
      tooltip.innerHTML = d
      tooltip.style.position = "absolute"
      tooltip.style.top = (event.screenY - 80) + "px"
      tooltip.style.left = (event.screenX - 80) + "px"


    }

    function hideTooltip(d, i, event) {

      document.getElementById("tooltip").style.visibility = "hidden"

    }

  
       
        



        var  colorSelector = 0, selectedValues = [], globalData = [], sn_myhsd = JSON.parse(localStorage.getItem("sn_myhsd")),  dateArray = []
        


          document.getElementById("selectedSpindles").innerHTML += "<b>Selected spindle</b>: <u>" + sn_myhsd 
        /* if(window.location.href.includes("?spindle=")){
          var params = new URLSearchParams(window.location.search);
          var query = params.get("spindle");
          var [spindle, date] = query.split("?date=");

          console.log("Spindle:", spindle);
          console.log("Date:", date);
          sn_myhsd.push([spindle, date])
        } 
        else sn_myhsd = JSON.parse(localStorage.getItem("selectedSpindles")); */


        


        function aggregateHelper(){


        

          if(document.getElementById("aggregato").checked == true){

            d3.selectAll("svg").remove()

            newGraph("", null, 1)

          } 

          else { //vuol dire che devo rendere visibili gli attributi di prima

            var to_add = document.getElementById("selectedValues").childNodes, selectedValues = []
    
           
            colorSelector -= 1

            ///

            
            ///

            for (let i = 0; i <= to_add.length; i++) {
              
              if(to_add[i] != undefined){

                if ((to_add[i].id != null) && (to_add[i].id.includes("label"))) {

               
                  var selectedGroup = to_add[i].innerHTML
                  var nsSelectedGroup = selectedGroup;
                  if (typeof selectedGroup !== "string") {
                    nsSelectedGroup = selectedGroup.toString();
                  }
                  if (nsSelectedGroup.includes(" ")) {
                    nsSelectedGroup = nsSelectedGroup.replace(/\s/g, "");
                  }
                  if(document.getElementById(nsSelectedGroup).checked == true) selectedValues.push(nsSelectedGroup)
                  
              
                }
           

              }
              
            }
            d3.select("#svg_default").remove()

            for (let i = 0; i <= selectedValues.length; i++) {
              d3.json(
                "http://arca.diag.uniroma1.it:8082/data/myhsd/" +
                sn_myhsd +
                "/raw_data?columns=" +
                selectedValues[i] +
                "&mode=1&limit=1000",
                { crossOrigin: "anonymous" }
              ).then(function (data) {
           
                newGraph(selectedValues[i], data, 3)


              });
            }


          }




        }

        function modifyElement(selectedGroup, flag){ 
          var selectedGroup = selectedGroup.id
       
          var nsSelectedGroup = selectedGroup;  
          if (typeof selectedGroup !== "string") {
            nsSelectedGroup = selectedGroup.toString();
          }
          if (nsSelectedGroup.includes(" ")) {
            nsSelectedGroup = nsSelectedGroup.replace(/\s/g, "");
          }
  
            var data = globalData
            //var selectedOption = JSON.parse(localStorage.getItem("selectedOption"));
            

            if (document.getElementById(selectedGroup).checked == true){

                var toAddDot = "#dot" + selectedGroup
                var toAddPath = "#path" + selectedGroup
                
                if(document.getElementById("aggregato").checked == true){

                  d3.select("#svg_default").selectAll(toAddDot).attr("visibility", "visible");
                  d3.select("#svg_default").selectAll(toAddPath).attr("visibility", "visible");

                }

                else{
                  d3.selectAll("#svg" + nsSelectedGroup).attr("visibility", "visible");
                }

            }
        //si cancella tutto ciò che fa parte del grafico con l'id selezionato
            else if (document.getElementById(selectedGroup).checked == false){

                var toRemoveDot = "#dot" + nsSelectedGroup
                var toRemovePath = "#path" + nsSelectedGroup

                if(document.getElementById("aggregato").checked == true){

                  
                  d3.selectAll(toRemoveDot).attr("visibility", "hidden");
                  d3.selectAll(toRemovePath).attr("visibility", "hidden");

                }

                else {
                  console.log("svg" +  nsSelectedGroup)
                  d3.selectAll("#svg" + nsSelectedGroup).remove()
                  document.getElementById(selectedGroup).remove()
                  document.getElementById("label" + selectedGroup).remove()
                  var values = JSON.parse(localStorage.getItem("selectedValues"))
                  if (values.includes(selectedGroup)) {

                    const index = values.indexOf(selectedGroup);
                    if (index > -1) { // only splice array when item is found
                      values.splice(index, 1); // 2nd parameter means remove one item only
                    }

                  }
                  localStorage.removeItem("selectedValues")
                  localStorage.setItem("selectedValues", JSON.stringify(values))

                }
                

                // da rivedere per colore
                if(colorSelector != -1) --colorSelector
                else colorSelector = 0
                
            }
            
        }

        function clearSvg(){

                console.log("Clearing svgs...")
                document.getElementById("selectedValues").innerHTML = ""
                document.getElementById("aggregato").checked = false 
                document.getElementById("selectMenuColumns").selectedIndex = 0; 

                d3.select("#svg_default").remove()    //attr("visibility", "hidden");
                d3.selectAll("svg").remove();

                /* document.getElementById("svg-div").remove()
                var svgDiv = document.createElement("div")
                svgDiv.classList.add("container");
                svgDiv.id = "svg-div";
                document.body.appendChild(svgDiv);
                document.getElementById("svg-div").innerHTML +=  "<div class='row' id='svg-row'>" */


                localStorage.removeItem("selectedValues");
                }


    function newGraph(selectedGroup, data, aggregato){

      var nsSelectedGroup = selectedGroup
      if (selectedGroup.includes(" ")) {
        nsSelectedGroup = selectedGroup.replace(/\s/g, "");
      }
      
      /* var dataLength = globalData["time"][0].length */ // un qualunque attributo tanto la lunghezza sempre quella è
      
      var scaleCheck = 0
      var dataset = [];
      var min = 100000
      var max = 0
      var timeArray = []
      var time = 0
      if(selectedGroup == null){

         selectedGroup = d3.select("#selectMenu").property("value");
         console.log("qua")

      } 

      
      //console.log(data["Tank piston return time"].data.length)
      if(data == null){
        console.log("ok")
        attributeLength = 59

      } 
      else{
       console.log("Debug: " + data);
        console.log("Selected Group: " + selectedGroup);
        console.log("Data Selected Group: " + data[selectedGroup]);
        console.log("Data Selected Group Data: " + data[selectedGroup].data);
        console.log("Data Selected Group Data Length: " + data[selectedGroup].data.length);

        var attributeLength = data[selectedGroup].data.length
        
        for (let i = 0; i < attributeLength; i++) {

          date = data[selectedGroup].data[i].date_timestamp
          //time = data[selectedGroup].data[i].date_timestamp.slice(10)
          
          dateArray.push(date)
          //timeArray.push(time)
        }

        console.log(date, time)
        

      } 
      /* var scaleCheck = 0
      var time = globalData["time"][0]
      var time_start = globalData["date start"][0]
      console.log(real_time) */
      //var real_time = aggiungiSecondi(time)
   

      /* if(document.getElementById("aggregato").checked != true) my_data = globalData[selectedGroup][0]
      console.log(globalData, my_data) */
     

          if(aggregato == 1){ // Caso AGGREGATO

            ///Variabili 
            

            const end = document.getElementById("day-end").innerHTML;

             if (end.length >= 10) {
              var start = document.getElementById("day-start").innerHTML

              
               const startDate = new Date(start);
               const endDate = new Date(end);
               const startFormatted = `${startDate.getDate()}/${startDate.getMonth() + 1}/${startDate.getFullYear().toString().slice(-2)}`;
               const endFormatted = `${endDate.getDate()}/${endDate.getMonth() + 1}/${endDate.getFullYear().toString().slice(-2)}`;
               startFormatted.replace("/", "%2F");
               endFormatted.replace("/", "%2F");

              var afterSelectedGroup = "&mode=1&limit=1000" +"&dateStart=" + startFormatted + "&dateEnd=" + endFormatted
          
             
            
            }

          

            ///FINE

            colorSelector = 0

            d3.select("#svg_default").attr("visibility", "visible");



            ///Scala per grafici OK

            var min = 100000
            var max = 0




            var valori = []
            var to_add = document.getElementById("selectedValues").childNodes

            for (let i = 0; i < to_add.length; i++) {
              

              if (to_add[i] != undefined) {

                if ((to_add[i].id != null) && (to_add[i].id.includes("label"))) {
                  console.log(to_add[i])
                  valori.push(to_add[i].innerHTML)


                }
              }

            }


            var scalaAggiuntiva = 0
            if (document.getElementById("svg_default") != null) document.getElementById("svg_default").remove()

            const margin = { top: 20, right: 30, bottom: 30, left: 50 };
            const width = 960 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

            ///SETTING DEL TESTO

            const zoom = d3.zoom()
              .extent([[0, 0], [width, height]])
              .scaleExtent([1, 10])
              .on("zoom", zoomed);

            const svg = d3.select("body").append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .attr("id", function (d, i) { return "svg_default" })
              .call(zoom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


            var clip = svg.append("defs").append("clipPath")
              .attr("id", "clip")
              .append("rect")
              .attr("width", width)
              .attr("height", height)
              .attr("x", 0)
              .attr("y", 0);




            var container = document.getElementById('svg-div');
            var xScale, yScale //Modificare dopo in caso di dataset diversi
            
            for (let j = 0; j < valori.length; j++) { //parte  per calcolare una sola yscale.



              sleep(1000).then(() => {
                var dataset = []
                var selectedGroup = valori[j]
                console.log("qua: " + selectedGroup)
                if(end.length < 10) afterSelectedGroup = ""

                d3.json(
                  "http://arca.diag.uniroma1.it:8082/data/myhsd/" +
                  sn_myhsd +
                  "/raw_data?columns=" +
                  selectedGroup + afterSelectedGroup,
                  { crossOrigin: "anonymous" }
                ).then(function (data) {
                  var attributeLength = data[selectedGroup].data.length


                  for (let i = 0; i < attributeLength; i++) {

                    dataset.push([data[selectedGroup].data[i].date_timestamp, data[selectedGroup].data[i].value])
                    if (data[selectedGroup].data[i].value < min) {
                      min = data[selectedGroup].data[i].value

                    }
                    if (data[selectedGroup].data[i].value > max) {
                      max = data[selectedGroup].data[i].value
                    }


                  }

                  
                    min = min - 5
                    max = max + 5
                  
                  yScale = d3.scaleLinear().domain([min, max]).range([height, 0]);
                  xScale = d3.scaleTime()
                    .domain(d3.extent(dataset, function (d) {
                      return new Date(d[0]);
                    }))
                    .range([0, width]);
                })
                
            })
          }


            


              for (let j = 0; j < valori.length; j++) { //parte onerosa

                

                sleep(1000).then(() => {
                  var dataset = []
                  var selectedGroup = valori[j]
                  var nsSelectedGroup = selectedGroup;
                  if (typeof selectedGroup !== "string") {
                    nsSelectedGroup = selectedGroup.toString();
                  }
                  if (nsSelectedGroup.includes(" ")) {
                    nsSelectedGroup = nsSelectedGroup.replace(/\s/g, "");
                  }
                d3.json(
                  "http://arca.diag.uniroma1.it:8082/data/myhsd/" +
                  sn_myhsd +
                  "/raw_data?columns=" +
                  selectedGroup + afterSelectedGroup,
                  { crossOrigin: "anonymous" }
                ).then(function (data) {
                  var attributeLength = data[selectedGroup].data.length


                  for (let i = 0; i < attributeLength; i++) {

                    dataset.push([data[selectedGroup].data[i].date_timestamp, data[selectedGroup].data[i].value])
                    if (data[selectedGroup].data[i].value < min) {
                      min = data[selectedGroup].data[i].value

                    }
                    if (data[selectedGroup].data[i].value > max) {
                      max = data[selectedGroup].data[i].value
                    }


                  }

                  console.log(dataset)
                  max = max + 5
                  min = min - 5



                  

                  

                  var xAxis = d3.axisBottom(xScale);
                  var yAxis = d3.axisLeft(yScale);

                  svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis);

                  svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis);


                  const line = d3.line()
                    .x(function (d) { return xScale(new Date(d[0])); })
                    .y(function (d) { return yScale(d[1]); });

                  svg.append("path")
                    .datum(dataset)
                    .attr("class", "line")
                    .attr("stroke", colors[colorSelector])
                    .attr("fill", "none")  // Imposta il riempimento a "none"
                    .attr("d", line)
                    .attr("id", function (d, i) { return "path" + nsSelectedGroup })
                    .attr("clip-path", "url(#clip)");

                  const points = svg.append("g")
                    .attr("class", "dots")
                    .attr("clip-path", "url(#clip)");

                  points.selectAll('.dot')
                    .data(dataset)
                    .enter()
                    .append('circle')
                    .attr('class', 'dot')
                    .attr("r", 2.5)
                    .attr('fill', colors[colorSelector])
                    .attr("id", function (d, i) { return "dot" + nsSelectedGroup })
                    .attr("transform", function (d) {
                      return "translate(" + xScale(new Date(d[0])) + "," + yScale(d[1]) + ")";
                    });


                  svg.append('text')
                    .attr('x', width / 2 + selectedGroup.length*12)
                    .attr('y', 0)
                    .attr('text-anchor', 'middle')
                    .style('font-family', 'Helvetica')
                    .style('font-size', 20)
                    .style('fill', colors[colorSelector])
                    .text("\u25A0 " + selectedGroup)






                  function zoomed(event) {
                    const { transform } = event;

                    const newXScale = transform.rescaleX(xScale);
                    const newYScale = transform.rescaleY(yScale);

                    svg.select(".x.axis").call(xAxis.scale(newXScale));
                    svg.select(".y.axis").call(yAxis.scale(newYScale));

                    svg.select(".line")
                      .attr("d", line.x(function (d) { return newXScale(new Date(d[0])); })
                        .y(function (d) { return newYScale(d[1]); }));

                    points.selectAll('.dot')
                      .attr("transform", function (d) {
                        return "translate(" + newXScale(new Date(d[0])) + "," + newYScale(d[1]) + ")";
                      });
                  }

                  if (colorSelector < colors.length) colorSelector += 1
                  else colorSelector = 0




                })
              })

              
                
                  




              }

            



            }



        else if ((aggregato == 0) || (aggregato == 3)){ //Caso NON aggregato, il 3 è solo per un piccolo sottocaso

          /* var parseTime = d3.timeParse("%H:%M:%S");
            var realTimeDates = real_time.map(function (timeString) {
              return parseTime(timeString);
            }); */

         

          for(let i = 0; i < attributeLength; i += 1){ //SINGOLO. Modificare il += 5 per aumentare o diminuire la velocità nel caricamento.
           
           

            

              
                dataset.push([data[selectedGroup].data[i].date_timestamp, data[selectedGroup].data[i].value]);
                if (data[selectedGroup].data[i].value < min) {
                  min = data[selectedGroup].data[i].value
                }
                if (data[selectedGroup].data[i].value > max) {
                  max = data[selectedGroup].data[i].value
                }    


                if (min == max){ 
                  min = min - 5
                  max = max + 5
                }
            

        }


          

          //Creazione grafico

          //document.getElementById("svg-div").innerHTML += '<div class="col-sm"><svg width="800" height="510" id="svg' + nsSelectedGroup+'"></svg></div>'
            
            const margin = { top: 20, right: 30, bottom: 30, left: 50 };
            const width = 960 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;
            const tooltip = d3.select("#tooltip");

            console.log(dataset)
            const xScale = d3.scaleTime()
              .domain(d3.extent(dataset, function (d) {
                return new Date(d[0]);
              }))
              .range([0, width]);

            const yScale = d3.scaleLinear()
              .domain([min, max])
              .range([height, 0]);

            const xAxis = d3.axisBottom(xScale);
            const yAxis = d3.axisLeft(yScale);

            const zoom = d3.zoom()
              .extent([[0, 0], [width, height]])
              .scaleExtent([1, 10])
              .on("zoom", zoomed);

            const svg = d3.select("body").append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .attr("id", function (d, i) { return "svg" + nsSelectedGroup })
              .call(zoom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var clip = svg.append("defs").append("clipPath")
              .attr("id", "clip")
              .append("rect")
              .attr("width", width)
              .attr("height", height)
              .attr("x", 0)
              .attr("y", 0);

            svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis);

            svg.append("g")
              .attr("class", "y axis")
              .call(yAxis);


            const line = d3.line()
              .x(function (d) { return xScale(new Date(d[0])); })
              .y(function (d) { return yScale(d[1]); });

            svg.append("path")
              .datum(dataset)
              .attr("class", "line")
              .attr("stroke", "#CC0000")
              .attr("fill", "none")  // Imposta il riempimento a "none"
              .attr("d", line)
              .attr("clip-path", "url(#clip)"); 

            const points = svg.append("g")
              .attr("class", "dots")
              .attr("clip-path", "url(#clip)");

           

            function zoomed(event) {
              const { transform } = event;

              const newXScale = transform.rescaleX(xScale);
              const newYScale = transform.rescaleY(yScale);

              svg.select(".x.axis").call(xAxis.scale(newXScale));
              svg.select(".y.axis").call(yAxis.scale(newYScale));

              svg.select(".line")
                .attr("d", line.x(function (d) { return newXScale(new Date(d[0])); })
                  .y(function (d) { return newYScale(d[1]); }));

              points.selectAll('.dot')
                .attr("transform", function (d) {
                  return "translate(" + newXScale(new Date(d[0])) + "," + newYScale(d[1]) + ")";
                });
            }


        }
        
        else if (aggregato == 2){ //Caso in cui voglio aggiungere grafici al grafico degli aggregati già aggregato. Devo disegnare un grafico invisibile e poi uno degli aggregati.

            
          
          ///Variabili 

          const end = document.getElementById("day-end").innerHTML;

            if (end.length >= 10) {
              var start = document.getElementById("day-start").innerHTML


              const startDate = new Date(start);
              const endDate = new Date(end);
              const startFormatted = `${startDate.getDate()}/${startDate.getMonth() + 1}/${startDate.getFullYear().toString().slice(-2)}`;
              const endFormatted = `${endDate.getDate()}/${endDate.getMonth() + 1}/${endDate.getFullYear().toString().slice(-2)}`;
              startFormatted.replace("/", "%2F");
              endFormatted.replace("/", "%2F");

              var afterSelectedGroup = "&mode=1&limit=1000" + "&dateStart=" + startFormatted + "&dateEnd=" + endFormatted



            }

            d3.selectAll("svg").remove()

            colorSelector = 0

            d3.select("#svg_default").attr("visibility", "visible");



            ///Scala per grafici OK

            var min = 100000
            var max = 0




            var valori = []
            var to_add = document.getElementById("selectedValues").childNodes

            for (let i = 0; i < to_add.length; i++) {


              if (to_add[i] != undefined) {

                if ((to_add[i].id != null) && (to_add[i].id.includes("label"))) {
                  console.log(to_add[i])
                  valori.push(to_add[i].innerHTML)


                }
              }

            }


            valori.push(selectedGroup)
            console.log(selectedGroup)
            if (document.getElementById("svg_default") != null) document.getElementById("svg_default").remove()

            const margin = { top: 20, right: 30, bottom: 30, left: 50 };
            const width = 960 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

            ///SETTING DEL TESTO

            const zoom = d3.zoom()
              .extent([[0, 0], [width, height]])
              .scaleExtent([1, 10])
              .on("zoom", zoomed);

            const svg = d3.select("body").append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .attr("id", function (d, i) { return "svg_default" })
              .call(zoom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


            var clip = svg.append("defs").append("clipPath")
              .attr("id", "clip")
              .append("rect")
              .attr("width", width)
              .attr("height", height)
              .attr("x", 0)
              .attr("y", 0);




            var container = document.getElementById('svg-div');
            var xScale, yScale //Modificare dopo in caso di dataset diversi

            for (let j = 0; j < valori.length; j++) { //parte  per calcolare una sola yscale.


              if(end.length < 10) afterSelectedGroup = "&mode=1&limit=1000"
              sleep(1000).then(() => {
                var dataset = []
                var selectedGroup = valori[j]
                console.log("qua: " + selectedGroup)
                d3.json(
                  "http://arca.diag.uniroma1.it:8082/data/myhsd/" +
                  sn_myhsd +
                  "/raw_data?columns=" +
                  selectedGroup +
                  afterSelectedGroup,
                  { crossOrigin: "anonymous" }
                ).then(function (data) {
                  var attributeLength = data[selectedGroup].data.length


                  for (let i = 0; i < attributeLength; i++) {

                    dataset.push([data[selectedGroup].data[i].date_timestamp, data[selectedGroup].data[i].value])
                    if (data[selectedGroup].data[i].value < min) {
                      min = data[selectedGroup].data[i].value

                    }
                    if (data[selectedGroup].data[i].value > max) {
                      max = data[selectedGroup].data[i].value
                    }


                  }


                  min = min - 5
                  max = max + 5

                  yScale = d3.scaleLinear().domain([min, max]).range([height, 0]);
                  xScale = d3.scaleTime()
                    .domain(d3.extent(dataset, function (d) {
                      return new Date(d[0]);
                    }))
                    .range([0, width]);
                })

              })
            }





            for (let j = 0; j < valori.length; j++) { //parte onerosa



              sleep(1000).then(() => {
                var dataset = []
                var selectedGroup = valori[j]
                var nsSelectedGroup = selectedGroup;
                if (typeof selectedGroup !== "string") {
                  nsSelectedGroup = selectedGroup.toString();
                }
                if (nsSelectedGroup.includes(" ")) {
                  nsSelectedGroup = nsSelectedGroup.replace(/\s/g, "");
                }
                d3.json(
                  "http://arca.diag.uniroma1.it:8082/data/myhsd/" +
                  sn_myhsd +
                  "/raw_data?columns=" +
                  selectedGroup +
                  afterSelectedGroup,
                  { crossOrigin: "anonymous" }
                ).then(function (data) {
                  var attributeLength = data[selectedGroup].data.length


                  for (let i = 0; i < attributeLength; i++) {

                    dataset.push([data[selectedGroup].data[i].date_timestamp, data[selectedGroup].data[i].value])
                    if (data[selectedGroup].data[i].value < min) {
                      min = data[selectedGroup].data[i].value

                    }
                    if (data[selectedGroup].data[i].value > max) {
                      max = data[selectedGroup].data[i].value
                    }


                  }

                  console.log(dataset)
                  max = max + 5
                  min = min - 5







                  var xAxis = d3.axisBottom(xScale);
                  var yAxis = d3.axisLeft(yScale);

                  svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis);

                  svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis);


                  const line = d3.line()
                    .x(function (d) { return xScale(new Date(d[0])); })
                    .y(function (d) { return yScale(d[1]); });

                  svg.append("path")
                    .datum(dataset)
                    .attr("class", "line")
                    .attr("stroke", colors[colorSelector])
                    .attr("fill", "none")  // Imposta il riempimento a "none"
                    .attr("d", line)
                    .attr("id", function (d, i) { return "path" + nsSelectedGroup })
                    .attr("clip-path", "url(#clip)");

                  const points = svg.append("g")
                    .attr("class", "dots")
                    .attr("clip-path", "url(#clip)");

                  points.selectAll('.dot')
                    .data(dataset)
                    .enter()
                    .append('circle')
                    .attr('class', 'dot')
                    .attr("r", 2.5)
                    .attr('fill', colors[colorSelector])
                    .attr("id", function (d, i) { return "dot" + nsSelectedGroup })
                    .attr("transform", function (d) {
                      return "translate(" + xScale(new Date(d[0])) + "," + yScale(d[1]) + ")";
                    });


                  svg.append('text')
                    .attr('x', width / 3 + colorSelector * selectedGroup.length * 12)
                    .attr('y', 0)
                    .attr('text-anchor', 'middle')
                    .style('font-family', 'Helvetica')
                    .style('font-size', 20)
                    .style('fill', colors[colorSelector])
                    .text("\u25A0 " + selectedGroup)






                  function zoomed(event) {
                    const { transform } = event;

                    const newXScale = transform.rescaleX(xScale);
                    const newYScale = transform.rescaleY(yScale);

                    svg.select(".x.axis").call(xAxis.scale(newXScale));
                    svg.select(".y.axis").call(yAxis.scale(newYScale));

                    svg.select(".line")
                      .attr("d", line.x(function (d) { return newXScale(new Date(d[0])); })
                        .y(function (d) { return newYScale(d[1]); }));

                    points.selectAll('.dot')
                      .attr("transform", function (d) {
                        return "translate(" + newXScale(new Date(d[0])) + "," + newYScale(d[1]) + ")";
                      });
                  }

                  if (colorSelector < colors.length) colorSelector += 1
                  else colorSelector = 0




                })
              })








            }


             
            

        }





            // codice finale
            //if (aggregato == 0) document.getElementById("selectedValues").style.visibility = "hidden"
       
            if ((aggregato != 1)  && (aggregato != 3)) {
             
              document.getElementById("selectedValues").innerHTML += '<input type = "checkbox" id = "' + nsSelectedGroup +'" onchange = "modifyElement('+ nsSelectedGroup +')" checked>' + "<label for='" + nsSelectedGroup + "' id = 'label" + nsSelectedGroup + "'>" + selectedGroup + "</label>" 
            }
              selectedValues.push(selectedGroup)
            localStorage.setItem("selectedValues", JSON.stringify(selectedValues))



            var svgElements = d3.selectAll("g").selectAll(".punto") //ogni volta, riaggungo gli eventi agli svg, perché sennò si cancellano

           
            

        }

   



 

  function formatDate(dateTimeString) {
    var dateTimeParts = dateTimeString.split("T");
    var date = dateTimeParts[0];
    var time = dateTimeParts[1];
    return date + "<br><b>Time: </b>" + time;
  }




  var globalData = []

  d3.select("#selectMenuColumns").on("change", function (d) {
    
      var selectedOption = d3.select(this).property("value");
      var start = document.getElementById("day-start").innerHTML
      var end = document.getElementById("day-end").innerHTML

      if((start.length >= 10) && (end.length >= 10)){

        const startDate = new Date(start);
        const endDate = new Date(end);

        const startFormatted = `${startDate.getDate()}/${startDate.getMonth() + 1}/${startDate.getFullYear().toString().slice(-2)}`;
        const endFormatted = `${endDate.getDate()}/${endDate.getMonth() + 1}/${endDate.getFullYear().toString().slice(-2)}`;

        startFormatted.replace("/", "%2F")
        endFormatted.replace("/", "%2F")
        console.log(startFormatted);
        console.log(endFormatted);

        d3.json(
        "http://arca.diag.uniroma1.it:8082/data/myhsd/" +
        sn_myhsd +
        "/raw_data?columns=" +
        selectedOption +
        "&mode=1&limit=1000" +
        "&dateStart=" + startFormatted + "&dateEnd=" +  endFormatted,
        { crossOrigin: "anonymous" }
      ).then(function (data) {
        console.log(data)
        console.log(data[selectedOption].data.length)
        if (data[selectedOption].data.length == 0) {
          showPopup("No data to show for this date range!", false)
      
        }
        else{
          console.log("epique")
          if(document.getElementById("aggregato").checked == false) newGraph(selectedOption, data, 0)
          else{ 
            console.log("chiamato il 2")
            newGraph(selectedOption, data, 2)
          } 

        }
        

      });
   

      }

      else{

        console.log("big chungus")

        d3.json(
          "http://arca.diag.uniroma1.it:8082/data/myhsd/" +
          sn_myhsd +
          "/raw_data?columns=" +
          selectedOption +
          "&mode=1&limit=1000",
          { crossOrigin: "anonymous" }
        ).then(function (data) {

          
            if (document.getElementById("aggregato").checked == false) newGraph(selectedOption, data, 0)
            else newGraph(selectedOption, data, 2)

          
          

        });

      }

      
    });

    document.addEventListener("DOMContentLoaded", function () {
        const observer = new MutationObserver(function (mutationsList) {
          for (let mutation of mutationsList) {
            if (mutation.type === 'childList' || mutation.type === 'characterData') {
              const end = document.getElementById("day-end").innerHTML;

              if ((end.length >= 10) && (document.getElementById("selectedValues") != null)) {
                // L'innerHTML di "day-end" è stato modificato e ha una lunghezza sufficiente
                // Esegui qui le azioni desiderate
                console.log('La mutazione dell\'innerHTML di "day-end" è avvenuta!');
                console.log('Ecco l\'end:', end);

                

                if(document.getElementById("aggregato").checked == true){
                  newGraph("", null, 1)
                  console.log("ARSENE!!")
                  return
                }
                var start = document.getElementById("day-start").innerHTML
                if (start.length < 10){
                  showPopup("Select the initial date first!", false)
                  resetFilters()
                  return

                } 

                // Puoi proseguire con il resto delle azioni qui
                
                var to_add = document.getElementById("selectedValues").childNodes;
                var selectedAttributes = [];
                const startDate = new Date(start);
                const endDate = new Date(end);
                const startFormatted = `${startDate.getDate()}/${startDate.getMonth() + 1}/${startDate.getFullYear().toString().slice(-2)}`;
                const endFormatted = `${endDate.getDate()}/${endDate.getMonth() + 1}/${endDate.getFullYear().toString().slice(-2)}`;
                startFormatted.replace("/", "%2F");
                endFormatted.replace("/", "%2F");

                var to_add = document.getElementById("selectedValues").childNodes, selectedValues = []


                colorSelector -= 1

                ///


                ///

                for (let i = 0; i <= to_add.length; i++) {

                  if (to_add[i] != undefined) {

                    if ((to_add[i].id != null) && (to_add[i].id.includes("label"))) {


                      var selectedGroup = to_add[i].innerHTML
                      var nsSelectedGroup = selectedGroup;
                      if (typeof selectedGroup !== "string") {
                        nsSelectedGroup = selectedGroup.toString();
                      }
                      if (nsSelectedGroup.includes(" ")) {
                        nsSelectedGroup = nsSelectedGroup.replace(/\s/g, "");
                      }
                      if (document.getElementById(nsSelectedGroup).checked == true) selectedAttributes.push(selectedGroup)


                    }


                  }
                }



                console.log(startFormatted, endFormatted);
                clearSvg();
                for (let j = 0; j < selectedAttributes.length; j++) {
                  (function (selectedOption) {
                    d3.json(
                      "http://arca.diag.uniroma1.it:8082/data/myhsd/" +
                      sn_myhsd +
                      "/raw_data?columns=" +
                      selectedOption +
                      "&mode=1&limit=1000" +
                      "&dateStart=" + startFormatted + "&dateEnd=" + endFormatted,
                      { crossOrigin: "anonymous" }
                    ).then(function (data) {
                      console.log(selectedOption);

                      if (data[selectedOption].data.length == 0) {
                        showPopup("No data to show for this date range!", false)

                      }
                      else{

                        if(document.getElementById("aggregato").checked == true) console.log("hapl")
                        else newGraph(selectedOption, data, 0);
                        

                      }
                      
                    });
                  })(selectedAttributes[j]);
                }

              }
            }
          }
        });

        const observerOptions = {
          childList: true,
          subtree: true,
          characterData: true
        };

        observer.observe(document.getElementById("day-end"), observerOptions);
      });



            

            

</script>
</body>
</html>